<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cmap Grader</title>
  <script src="https://cdn.jsdelivr.net/gh/golang/go@go1.19.5/misc/wasm/wasm_exec.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
    integrity="sha256-wLz3iY/cO4e6vKZ4zRmo4+9XDpMcgKOvv/zEU3OMlRo=" crossorigin="anonymous">
  <script>
    const go = new Go();
    WebAssembly.instantiateStreaming(fetch("cmap.wasm"), go.importObject).then((result) => {
      go.run(result.instance);
    });
  </script>
</head>

<body class="container py-3">
  <h1>Concept Map Grader</h1>
  <form id="form">
    <p>Select a Concept Map Outline file. In CmapTools, this is available under <b>Exports &rsaquo; Cmap Outline</b>.
    </p>
    <input type="file" id="file" accept=".txt,.cxl,.xml" class="form-control mb-3" />

    <input type="url" id="url" onkeydown="clearFileInput" class="form-control mb-3" />

    <button type="submit" class="btn btn-dark">Grade Concept Map</button>
  </form>

  <div id="success" style="display: none;">
    <div class="input-group mt-3">
      <span class="input-group-text">Node Count</span>
      <input type="text" class="form-control" readonly id="nodes" />
    </div>
    <div class="input-group mt-3">
      <span class="input-group-text">Connection Count</span>
      <input type="text" class="form-control" readonly id="conns" />
    </div>
    <div class="input-group mt-3">
      <span class="input-group-text">Highest Hierarchy Length</span>
      <input type="text" class="form-control" readonly id="hhl" />
    </div>
    <h3 class="mt-3">Highest Hierarchy</h3>
    <textarea class="form-control" id="hh" readonly style="min-height: 200px;"></textarea>
  </div>

  <div id="failure" style="display: none;">
    <div class="alert alert-danger" role="alert" id="error"></div>
  </div>

  <script>
    const success = document.getElementById("success");
    const failure = document.getElementById("failure");
    const nodes = document.getElementById("nodes");
    const conns = document.getElementById("conns");
    const hhl = document.getElementById("hhl");
    const hh = document.getElementById("hh");
    const error = document.getElementById("error");
    const clearFileInput = () => {
      document.getElementById("file").value = "";
    };

    const execute = (input) => {
      const rawInput = JSON.stringify(input);
      const cmapRaw = gradecmap(rawInput);

      const cmap = JSON.parse(cmapRaw);
      if (cmap.error) {
        success.style.display = 'none';
        failure.style.display = 'block';

        error.innerText = cmap.message;
      } else {
        success.style.display = 'block';
        failure.style.display = 'none';

        nodes.value = cmap.data.nodes;
        conns.value = cmap.data.connections;
        hhl.value = cmap.data.longestPathLength;
        hh.value = cmap.data.longestPath.reduce((a, b, c, d) => {
          if (c === 0) return b;

          if (c % 2 === 1) {
            return a + '\n\t(' + b + ')';
          }

          return a + ' ' + b;
        }, '');
      }
    };

    document.getElementById('form').addEventListener('submit', (ev) => {
      ev.preventDefault();

      const file = document.getElementById('file').files[0];
      const url = document.getElementById('url').value;

      if (!file && !url) {
        success.style.display = 'none';
        failure.style.display = 'block';

        error.innerText = 'Please select a file or enter a URL.';
        return;
      }

      try {
        if (!file) new URL(url);
      } catch (e) {
        success.style.display = 'none';
        failure.style.display = 'block';

        error.innerText = 'Please enter a valid URL (starts with https://).';
        return;
      }

      if (file) {
        const reader = new FileReader();
        reader.onload = () => {
          const fileData = reader.result.split(",").pop();
          const extension = file.name.split('.').pop();

          execute({ file: fileData, format: extension === 'txt' ? 0 : 1 });
        };
        reader.readAsDataURL(file);
      } else {
        const urlIdRegex = /([0-9A-Z]+\-[0-9A-Z]+\-[0-9A-Z]+)/;
        const urlMatch = url.match(urlIdRegex);

        if (!urlMatch) {
          success.style.display = 'none';
          failure.style.display = 'block';

          error.innerText = 'Please enter a valid URL (starts with https://).';
          return;
        }

        fetch(`https://cmapscloud.ihmc.us/resources/id=${urlMatch[0]}?cmd=get.cmap.v3`).then((res) => res.arrayBuffer()).then((data) => {
          const blob = new Blob([data], { type: 'application/octet-binary' });
          const reader = new FileReader();
          reader.onload = function (evt) {
            const fileData = reader.result.split(",").pop();
            execute({ file: fileData, format: 1 });
          };
          reader.readAsDataURL(blob);
        }).catch(() => {
          success.style.display = 'none';
          failure.style.display = 'block';

          error.innerText = 'Failed to get information from the URL.';
        });
      }
    });
  </script>
</body>

</html>